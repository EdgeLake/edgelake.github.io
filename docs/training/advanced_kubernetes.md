---
layout: default
parent: training
title: Advanced Kubernetes
---
# Advanced Kubernetes

The following provides networking and volume details. 

## Networking

EdgeLake uses <a href="https://kubernetes.io/docs/concepts/services-networking/cluster-ip-allocation/" target="_blank">dynamic ClusterIP</a> 
as it's preferred setup. This means a unique IP address is automatically assigned to the services as they are created 
and ensures load balancing across the pods in the service.

### Configuring the network services on the EdgeLake node

Since dynamic ClusterIP generates a new IP whenever a pod is deployed, this causes a issue with EdgeLake's metadata 
(hosted in a blockchain or a master node) as each new IP will generate a new policy. To resolve this issue, and avoid 
policy updates, specify the host's internal IP as the `OVERLAY_IP` value. 

The following chart summarizes the setup:
<table>
  <thead>
    <tr>
      <th style="text-align:center;">Connection Type</th>
      <th style="text-align:center;">External IP</th>
      <th style="text-align:center;">Internal IP</th>
      <th style="text-align:center;">Config Command</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align:center;">TCP</td>
      <td style="text-align:center;">External IP</td>
      <td style="text-align:center;">Overlay IP</td>
      <td style="text-align:center;"><code class="language-anylog">run tcp server</code></td>
    </tr>
    <tr>
      <td style="text-align:center;">REST</td>
      <td style="text-align:center;">External IP</td>
      <td style="text-align:center;">Overlay IP</td>
      <td style="text-align:center;"><code class="language-anylog">run REST server</code></td>
    </tr>
    <tr>
      <td style="text-align:center;">Message Broker (TCP)</td>
      <td style="text-align:center;">External IP</td>
      <td style="text-align:center;">Overlay IP</td>
      <td style="text-align:center;"><code class="language-anylog">run message broker</code></td>
    </tr>
  </tbody>
</table>

Additional information on the network configuration are in the <a href="https://github.com/AnyLog-co/documentation/blob/master/network%20configuration.mdn" target="_blank">networking section</a>.

## Peer-to-peer Communication

Kubernetes has 3 base networking configurations:
<ul>
  <li><i>ClusterIP</i> -  Exposes the service on an internal IP within the cluster, making it accessible only within the cluster.</li>
  <li><i>NodePort</i> - Exposes the service on a static port on each node's IP, allowing external traffic to access the service.</li>
  <li><i>LoadBalancer</i> - Exposes the service externally using a cloud provider's load balancer, distributing traffic across multiple nodes.</li>
</ul>

The configuration files are set to use ClusterIP by default, expecting users to enable port-forwarding for ports that 
need to communicate with services outside the Kubernetes network. By default, the deploy_node.sh script enables 
port-forwarding for all the ports the Kubernetes instance will be using. 

**Note**: When using Kubernetes, makes sure ports are open and accessible across your network. 


## Volumes
The base deployment has the same general volumes as a docker deployment, and uses <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" target="_blank">PersistentVolumeClaim</a> 
- _data_, _blockchain_, _EdgeLake_ and _local-scripts (deployments)_.

While _data_, _blockchain_ and _anylog_ are autogenerated and populated, _local-scripts_ gets downloaded as part of the 
container image. Therefore, we utilize an `if/else` process to make this data persistent. 

**Note**: we copy the scripts to a persistent volume that is created after the initialization of the Pod.

<pre class="code-frame"><code class="language-shell">if [[ -d $EdgeLake_PATH/deployment-scripts ]] && [[ -z $(ls -A $EdgeLake_PATH/deployment-scripts) ]]; then # if directory exists but empty
  git clone -b os-dev https://github.com/EdgeLake-co/deployment-scripts deployment-scripts-tmp
  mv deployment-scripts-tmp/* deployment-scripts
  rm -rf deployment-scripts-tmp
elif [[ ! -d $EdgeLake_PATH/deployment-scripts ]] ; then  # if directory DNE
  git clone -b os-dev https://github.com/EdgeLake-co/deployment-scripts
fi</code></pre>

Once a node is up and running, users can change content in _local-scripts_ using `kubectl exec ${POD_NAME} -- /bin/bash`.

Volumes are deployed automatically as part of deploy_node.sh, and remain persistent as long as PersistentVolumeClaims
are not removed. 
